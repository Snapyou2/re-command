<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4142e0">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/favicon.ico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TrackDrop</title>
    <style>
        :root {
            --primary-color: #4142e0; 
            --secondary-color: #3fbbda;
            --accent-color: #80f2ff; 
            --background-color: #1a1a2e;
            --card-background: #2e2e4a;
            --text-color: #e0e0e0;
            --border-color: #4a4a6a;
            --success-color: #28a745;
            --error-color: #dc3545;
            --info-color: #17a2b8;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px; /* Base padding */
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            justify-content: center; /* Center content by default */
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
            transition: padding-right 0.3s ease-out, justify-content 0.3s ease-out; /* Smooth transition for padding and centering */
        }

        body.download-queue-panel-open {
            padding-right: calc( (500px) + 20px);
            justify-content: flex-start; /* Align main content to the left when panel is open */
        }
        #downloadQueueModalContent {
            padding-right: 40px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto; /* Center by default */
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.8s ease-out;
            position: relative;
            transition: max-width 0.3s ease-out; /* Only max-width transition needed now */
        }
        /* When panel is open, container will naturally adjust within the new body padding. */
        /* No specific .container adjustment needed when body.download-queue-panel-open is active. */

        .header-icons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px; /* Space between icons */
        }

        .header-icon {
            width: 26px; 
            height: 26px;
            cursor: pointer;
            filter: invert(1);
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .header-icon:hover {
            filter: invert(1);
            opacity: 1;
        }

        /* Styles for the download queue modal */
        .header-icon-top-left {
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .header-icons-top-right {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px; /* Space between icons */
        }
        .download-queue-modal {
            position: fixed;
            top: 20px; /* Add top margin */
            right: calc(-500px + 17px); /* Hidden initially, adjust for scrollbar width */
            width: calc(500px - 17px); /* Adjust width for scrollbar */
            max-width: calc(90% - 17px); /* Max width on smaller screens, adjust for scrollbar */
            height: calc(100% - 40px); /* Adjust height for top and bottom margin */
            background-color: var(--card-background);
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: right 0.3s ease-out;
            display: flex; /* Use flexbox for content alignment */
            flex-direction: column;
            border-top-left-radius: 12px; /* Rounded corners for the panel */
            border-bottom-left-radius: 12px;
        }

        .download-queue-modal.open {
            right: 0;
        }

        .download-queue-modal .modal-content {
            margin: 0; /* Remove margin from original modal-content */
            padding: 30px;
            padding-right: 40px; /* Add 40px right padding */
            /* border-radius: 0; Removed to allow outer radius to show */
            box-shadow: none; /* Remove box-shadow */
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .download-queue-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            margin-bottom: 8px;
            background-color: #3a3a5a;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            flex-direction: column;
        }

        .download-queue-item.in_progress { border-left: 4px solid var(--info-color); }
        .download-queue-item.completed { border-left: 4px solid var(--success-color); }
        .download-queue-item.failed { border-left: 4px solid var(--error-color); }

        .download-queue-item-header {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .download-queue-item .track-info {
            flex-grow: 1;
            margin-left: 10px;
            min-width: 0;
        }

        .download-queue-item .track-info > div {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }

        .download-queue-item .status-icon {
            width: 32px;
            height: 32px;
            margin-left: 10px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .download-queue-item .status-icon.in_progress {
            animation: none;
        }
        .download-queue-item .status-icon.completed svg { color: var(--success-color); }
        .download-queue-item .status-icon.failed svg { color: var(--error-color); }

        /* Progress bar */
        .dq-progress-bar {
            width: 100%;
            height: 4px;
            background-color: #2a2a4a;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        .dq-progress-bar-inner {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Stats row */
        .dq-stats {
            display: flex;
            gap: 12px;
            font-size: 0.8em;
            margin-top: 6px;
            flex-wrap: wrap;
        }
        .dq-stat { display: flex; align-items: center; gap: 4px; }
        .dq-stat-dot {
            width: 8px; height: 8px; border-radius: 50%; display: inline-block;
        }
        .dq-stat-dot.downloaded { background-color: var(--success-color); }
        .dq-stat-dot.skipped { background-color: var(--secondary-color); }
        .dq-stat-dot.failed { background-color: var(--error-color); }
        .dq-stat-dot.pending { background-color: #666; }

        /* Expandable track list */
        .dq-expand-btn {
            background: none; border: none; color: var(--accent-color);
            cursor: pointer; font-size: 0.8em; padding: 4px 0; margin-top: 4px;
            transition: color 0.2s; width: auto; box-shadow: none;
        }
        .dq-expand-btn:hover { color: var(--primary-color); background: none; transform: none; }
        .dq-track-list {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 6px;
            display: none;
        }
        .dq-track-list.open { display: block; }
        .dq-track-entry {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
            gap: 8px;
        }
        .dq-track-entry:nth-child(odd) { background-color: rgba(255,255,255,0.03); }
        .dq-track-entry .dq-track-status-icon {
            width: 14px; height: 14px; flex-shrink: 0;
        }
        .dq-track-entry .dq-track-label { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .dq-track-entry .dq-track-msg { color: #888; font-size: 0.9em; flex-shrink: 0; }

        /* Responsive adjustments for the download queue */
        @media (max-width: 768px) {
            .download-queue-modal {
                width: calc(85% - 17px);
                right: calc(-85% + 17px);
                top: 0;
                height: 100%;
                border-radius: 0;
                border-top-left-radius: 12px;
                border-bottom-left-radius: 12px;
                z-index: 1100;
            }
            /* On mobile, overlay the panel instead of pushing content */
            body.download-queue-panel-open {
                padding-right: 20px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background-color: var(--card-background);
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: var(--text-color);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        h2 {
            color: var(--secondary-color);
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        input[type="text"], input[type="password"] {
            width: calc(100% - 24px);
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background-color: #3a3a5a;
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(106, 13, 173, 0.3);
            outline: none;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin-right: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
            animation: slideIn 0.5s ease-out;
            z-index: 1000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.success {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        .message.error {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }
        .message.info {
            background-color: rgba(23, 162, 184, 0.2);
            color: var(--info-color);
            border: 1px solid var(--info-color);
        }
        .message.warning {
            background-color: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .playlist-section {
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            padding-top: 30px;
        }

        .playlist-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .playlist-toggle {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .playlist-toggle:hover {
            background-color: rgba(255, 193, 7, 0.1);
        }

        .playlist-content {
            display: block;
        }

        .playlist-content.collapsed {
            display: none;
        }

        .playlist-status {
            font-size: 0.9em;
            color: var(--text-color);
            margin-left: 10px;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            background-color: var(--card-background);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .playlist-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .feedback-buttons {
            display: flex;
            flex-direction: row;
            gap: 5px;
            margin-left: 15px;
        }

        .feedback-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
        }

        .feedback-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .feedback-btn:active {
            transform: scale(0.95);
        }

        .like-btn:hover {
            background-color: rgba(40, 167, 69, 0.2);
        }

        .dislike-btn:hover {
            background-color: rgba(220, 53, 69, 0.2);
        }

        .feedback-icon {
            width: 20px;
            height: 20px;
            transition: opacity 0.2s ease;
        }

        .feedback-btn:hover .feedback-icon {
            opacity: 1;
        }

        .feedback-icon.success-feedback {
            background-color: var(--success-color);
            transform: scale(1.2);
        }

        .feedback-icon.error-feedback {
            background-color: var(--error-color);
            transform: scale(1.2);
        }

        .album-art-container {
            position: relative;
            width: 60px;
            height: 60px;
            min-width: 60px;
            margin-right: 20px;
            border-radius: 6px;
            background-color: #3a3a5a;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .album-art {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .album-art.loaded {
            opacity: 1;
        }

        .album-art-spinner {
            position: absolute;
            display: block;
            width: 32px; /* Adjusted size */
            height: 32px; /* Adjusted size */
            background-image: url('/assets/default-album.svg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            animation: spin 2s linear infinite; /* Use spin animation */
        }

        .track-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .track-title {
            font-weight: 700;
            margin: 0;
            font-size: 1.1em;
            color: var(--text-color);
        }

        .track-artist {
            margin: 4px 0 2px 0;
            color: #b0b0b0;
            font-size: 0.95em;
        }

        .track-album {
            margin: 2px 0 0 0;
            font-style: italic;
            color: #888;
            font-size: 0.9em;
        }

        .logo {
            width: 100%;
            height: auto;
            max-width: 125px;
            display: block;
            margin: 0 auto 20px auto;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.3));
        }

        .service-logo {
            margin: 0 20px 20px 0;
            max-width: 250px;
        }

        .settings {
            background-color: #3a3a5a;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 30px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .settings summary {
            cursor: pointer;
            font-weight: bold;
            color: var(--accent-color);
            font-size: 1.2em;
            padding: 5px 0;
            transition: color 0.3s ease;
        }

        .settings summary:hover {
            color: var(--primary-color);
        }

        .playlist-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .spinner {
            display: inline-block;
            width: 32px; /* Twice as big */
            height: 32px; /* Twice as big */
            background-image: url('/assets/default-album.svg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            animation: spin 2s linear infinite; /* Apply spin animation */
        }

        /* Specific style for spinner within download queue modal */
        .download-queue-modal .spinner {
            width: 48px; /* Twice as big */
            height: 48px; /* Twice as big */
        }

        .download-queue-modal .close-btn-svg {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 28px; /* Slightly larger for visibility */
            height: 28px;
            cursor: pointer;
            color: var(--text-color); /* Use text color for visibility */
            opacity: 0.7;
            transition: opacity 0.3s ease;
            z-index: 1001; /* Ensure it's above other modal content */
        }

        .download-queue-modal .close-btn-svg:hover {
            opacity: 1;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.6; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.6; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .download-btn {
            background-color: var(--accent-color) !important;
            color: black !important;
        }

        .download-btn:hover {
            background-color: #8080ff !important;
        }

        /* Fresh Releases Carousel */
        .carousel-container {
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .carousel {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
            gap: 20px;
            padding: 10px 0;
        }

        .carousel::-webkit-scrollbar {
            display: none;
        }

        .carousel-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .carousel-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.1);
        }

        .prev-btn {
            margin-right: 10px;
        }

        .next-btn {
            margin-left: 10px;
        }

        .release-item {
            flex: 0 0 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--card-background);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: center;
            min-height: 280px;
        }

        .release-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .release-art-container {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 8px;
            background-color: #3a3a5a;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }

        .release-art {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .release-art.loaded {
            opacity: 1;
        }

        .release-art-spinner {
            position: absolute;
            display: block;
            width: 40px; /* Adjusted size */
            height: 40px; /* Adjusted size */
            background-image: url('/assets/default-album.svg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            animation: spin 2s linear infinite; /* Use spin animation */
        }

        .release-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            justify-content: space-between;
            height: 100%;
        }

        .release-artist {
            font-weight: bold;
            font-size: 1em;
            color: var(--text-color);
            margin: 0;
        }

        .release-album {
            font-weight: normal;
            font-size: 0.9em;
            color: var(--text-color);
            margin: 0;
        }

        .release-date {
            font-size: 0.8em;
            color: #b0b0b0;
            margin: 0;
        }

        .release-download-btn {
            background-color: var(--accent-color);
            color: black;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 0.8em;
            cursor: pointer;
            margin-top: 5px;
            transition: background-color 0.3s ease;
        }

        .release-download-btn:hover {
            background-color: #8080ff;
        }

        .release-download-btn:disabled {
            background-color: var(--border-color);
            color: var(--text-color);
            cursor: not-allowed;
        }

        .download-link-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 2em;
            }
            .playlist-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .album-art {
                margin-bottom: 10px;
                margin-right: 0;
            }
            .playlist-controls {
                flex-direction: column;
            }
            button {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            .release-item {
                flex: 0 0 150px;
            }
            .release-art {
                width: 100px;
                height: 100px;
            }
            .download-link-row {
                flex-direction: column;
            }
            .download-link-row input[type="text"] {
                width: 100% !important;
            }
            .download-link-row button {
                width: 100%;
            }
        }
        /* Playlist mode popup */
        .pl-popup-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center;
        }
        .pl-popup-overlay.open { display: flex; }
        .pl-popup {
            background: #2a2a3e; border-radius: 12px; padding: 24px; max-width: 420px; width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.1);
        }
        .pl-popup h3 { margin: 0 0 12px; }
        .pl-popup p { color: #b0b0b0; font-size: 0.9em; margin: 0 0 16px; }
        .pl-popup-btns { display: flex; flex-direction: column; gap: 10px; }
        .pl-popup-btns button {
            padding: 12px 16px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 0.95em; transition: background 0.2s;
        }
        .pl-popup-btns .btn-monitor { background: var(--accent-color); color: #000; }
        .pl-popup-btns .btn-monitor:hover { filter: brightness(1.15); }
        .pl-popup-btns .btn-once { background: #3a3a5a; color: var(--text-color); }
        .pl-popup-btns .btn-once:hover { background: #4a4a6a; }
        .pl-popup-interval {
            display: none; margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.04);
            border-radius: 8px;
        }
        .pl-popup-interval.open { display: block; }
        .pl-popup-interval label { font-size: 0.85em; color: #b0b0b0; }
        .pl-popup-interval select {
            margin-top: 4px; padding: 8px; border-radius: 4px; width: 100%;
            background-color: #3a3a5a; color: var(--text-color); border: 1px solid var(--border-color);
        }

        /* Monitored playlists list in settings */
        .mp-list { margin-top: 12px; }
        .mp-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 12px; border-radius: 8px; margin-bottom: 8px;
            background: rgba(255,255,255,0.04);
        }
        .mp-item-info { flex: 1; min-width: 0; }
        .mp-item-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mp-item-meta { font-size: 0.8em; color: #888; margin-top: 2px; }
        .mp-item-actions { display: flex; gap: 6px; align-items: center; flex-shrink: 0; margin-left: 10px; }
        .mp-item-actions select {
            padding: 4px 6px; border-radius: 4px; font-size: 0.8em;
            background-color: #3a3a5a; color: var(--text-color); border: 1px solid var(--border-color);
        }
        .mp-item-actions button {
            padding: 4px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;
        }
        .mp-btn-sync { background: var(--accent-color); color: #fff; }
        .mp-btn-remove { background: var(--error-color); color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-icon-top-left">
            <!-- Gear icon inline for consistent styling -->
            <svg class="header-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="openSettingsModal()">
                <path d="M15 12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12C9 10.3431 10.3431 9 12 9C13.6569 9 15 10.3431 15 12Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12.9046 3.06005C12.6988 3 12.4659 3 12 3C11.5341 3 11.3012 3 11.0954 3.06005C10.7942 3.14794 10.5281 3.32808 10.3346 3.57511C10.2024 3.74388 10.1159 3.96016 9.94291 4.39272C9.69419 5.01452 9.00393 5.33471 8.36857 5.123L7.79779 4.93281C7.3929 4.79785 7.19045 4.73036 6.99196 4.7188C6.70039 4.70181 6.4102 4.77032 6.15701 4.9159C5.98465 5.01501 5.83376 5.16591 5.53197 5.4677C5.21122 5.78845 5.05084 5.94882 4.94896 6.13189C4.79927 6.40084 4.73595 6.70934 4.76759 7.01551C4.78912 7.2239 4.87335 7.43449 5.04182 7.85566C5.30565 8.51523 5.05184 9.26878 4.44272 9.63433L4.16521 9.80087C3.74031 10.0558 3.52786 10.1833 3.37354 10.3588C3.23698 10.5141 3.13401 10.696 3.07109 10.893C3 11.1156 3 11.3658 3 11.8663C3 12.4589 3 12.7551 3.09462 13.0088C3.17823 13.2329 3.31422 13.4337 3.49124 13.5946C3.69158 13.7766 3.96395 13.8856 4.50866 14.1035C5.06534 14.3261 5.35196 14.9441 5.16236 15.5129L4.94721 16.1584C4.79819 16.6054 4.72367 16.829 4.7169 17.0486C4.70875 17.3127 4.77049 17.5742 4.89587 17.8067C5.00015 18.0002 5.16678 18.1668 5.5 18.5C5.83323 18.8332 5.99985 18.9998 6.19325 19.1041C6.4258 19.2295 6.68733 19.2913 6.9514 19.2831C7.17102 19.2763 7.39456 19.2018 7.84164 19.0528L8.36862 18.8771C9.00393 18.6654 9.69420 18.9855 9.94291 19.6073C10.1159 20.0398 10.2024 20.2561 10.3346 20.4249C10.5281 20.6719 10.7942 20.8521 11.0954 20.94C11.3012 21 11.5341 21 12 21C12.4659 21 12.6988 21 12.9046 20.94C13.2058 20.8521 13.4719 20.6719 13.6654 20.4249C13.7976 20.2561 13.8841 20.0398 14.0571 19.6073C14.3058 18.9855 14.9961 18.6654 15.6313 18.8773L16.1579 19.0529C16.605 19.2019 16.8286 19.2764 17.0482 19.2832C17.3123 19.2913 17.5738 19.2296 17.8063 19.1042C17.9997 18.9999 18.1664 18.8333 18.4996 18.5001C18.8328 18.1669 18.9994 18.0002 19.1037 17.8068C19.2291 17.5743 19.2908 17.3127 19.2827 17.0487C19.2759 16.8291 19.2014 16.6055 19.0524 16.1584L18.8374 15.5134C18.6477 14.9444 18.9344 14.3262 19.4913 14.1035C20.036 13.8856 20.3084 13.7766 20.5088 13.5946C20.6858 13.4337 20.8218 13.2329 20.9054 13.0088C21 12.7551 21 12.4589 21 11.8663C21 11.3658 21 11.1156 20.9289 10.893C20.866 10.696 20.763 10.5141 20.6265 10.3588C20.4721 10.1833 20.2597 10.0558 19.8348 9.80087L19.5569 9.63416C18.9478 9.26867 18.6939 8.51514 18.9578 7.85558C19.1262 7.43443 19.2105 7.22383 19.232 7.01543C19.2636 6.70926 19.2003 6.40077 19.0506 6.13181C18.9487 5.94875 18.7884 5.78837 18.4676 5.46762C18.1658 5.16584 18.0149 5.01494 17.8426 4.91583C17.5894 4.77024 17.2992 4.70174 17.0076 4.71872C16.8091 4.73029 16.6067 4.79777 16.2018 4.93273L15.6314 5.12287C14.9961 5.33464 14.3058 5.01450 14.0571 4.39272C13.8841 3.96016 13.7976 3.74388 13.6654 3.57511C13.4719 3.32808 13.2058 3.14794 12.9046 3.06005Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <div class="header-icons-top-right">
            <!-- Download queue icon -->
            <svg class="header-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="openDownloadQueueModal()">
                <path d="M 17.727626,19.369618 V 0.99999999 m 0,18.36961801 -5.004657,-5.009896 m 5.004657,5.009896 5.004658,-5.009896 M 1,1.7696715 H 12.200214 M 1,7.4045513 H 12.200214 M 1,13.03943 h 5.6001067" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <!-- Logout icon -->
            <svg class="header-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="window.location.href='/logout'" title="Logout ({{ username }})">
                <path d="M16 17L21 12M21 12L16 7M21 12H9M9 3H7.8C6.11984 3 5.27976 3 4.63803 3.32698C4.07354 3.6146 3.6146 4.07354 3.32698 4.63803C3 5.27976 3 6.11984 3 7.8V16.2C3 17.8802 3 18.7202 3.32698 19.362C3.6146 19.9265 4.07354 20.3854 4.63803 20.673C5.27976 21 6.11984 21 7.8 21H9" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <!-- Spacer to clear header icons -->
        <div style="height: 40px;"></div>

        <div id="message" class="message" style="display: none;"></div>

        <!-- Welcome message for empty configuration -->
        <div id="welcomeMessage" class="playlist-section" style="display: none;">
            <div style="text-align: center; padding: 40px;">
                <h2 style="color: var(--primary-color); margin-bottom: 20px;">Welcome to TrackDrop!</h2>
                <p style="font-size: 1.2em; margin-bottom: 30px; color: var(--text-color);">
                    To get started, please configure your music services in the settings menu (gear icon in the top left).
                </p>
                <p style="color: #b0b0b0; margin-bottom: 20px;">
                    You can set up ListenBrainz for music discovery and recommendations, Last.fm for additional playlist sources, and Navidrome for your music library management.
                </p>
                <button onclick="openSettingsModal()" style="font-size: 1.1em; padding: 12px 24px;">
                    Open Settings
                </button>
            </div>
        </div>

        <div id="downloadFromLinkSection" class="playlist-section" style="border-top: none; padding-top: 10px; margin-top: 10px;">
            <div class="form-group" style="margin-bottom: 10px;">
                <div class="download-link-row">
                    <input type="text" id="musicLinkInput" placeholder="Paste a song, album, or playlist link..." style="flex: 1; width: 100%;">
                    <button id="downloadLinkBtn" onclick="downloadFromLink()" style="white-space: nowrap; margin: 0;">Download</button>
                </div>
            </div>
        </div>

        <div id="freshReleasesSection" class="playlist-section" style="display: none;">
            <div class="playlist-header">
                <h2>Fresh Releases</h2>
            </div>
            <div id="freshReleasesPlaylist" class="playlist-content"></div>
        </div>

        <div id="listenBrainzSection" class="playlist-section" style="display: none;">
            <div class="playlist-header">
                <img src="/assets/ListenBrainz_logo.svg" alt="ListenBrainz" class="logo service-logo">
                <h2></h2>
                <div>
                    <span id="listenBrainzStatus" class="playlist-status"></span>
                    <button id="listenBrainzToggle" class="playlist-toggle" onclick="togglePlaylist('listenBrainz')" style="display: none;">▼</button>
                </div>
            </div>
            <div id="listenBrainzButtons" class="playlist-controls">
                <button onclick="discoverListenBrainzPlaylist()">Discover Weekly Playlist</button>
                <button onclick="downloadListenBrainzPlaylistDirect()">Download Weekly Playlist</button>
            </div>
            <div id="listenBrainzPlaylist" class="playlist-content"></div>
        </div>

        <div id="lastFmSection" class="playlist-section" style="display: none;">
            <div class="playlist-header">
                <img src="/assets/Last.fm_logo.svg" alt="Last.fm" class="logo service-logo">
                <div>
                    <span id="lastFmStatus" class="playlist-status"></span>
                    <button id="lastFmToggle" class="playlist-toggle" onclick="togglePlaylist('lastFm')" style="display: none;">▼</button>
                </div>
            </div>
            <div id="lastFmButtons" class="playlist-controls">
                <button onclick="discoverLastFmPlaylist()">Discover Weekly Playlist</button>
                <button onclick="downloadLastFmPlaylistDirect()">Download Weekly Playlist</button>
            </div>
            <div id="lastFmPlaylist" class="playlist-content"></div>
        </div>

        <div id="llmSection" class="playlist-section" style="display: none;">
            <div class="playlist-header">
                <div id="llmHeaderContent">
                    <h2>LLM Suggestions</h2>
                </div>
                <div>
                    <span id="llmStatus" class="playlist-status"></span>
                    <button id="llmToggle" class="playlist-toggle" onclick="togglePlaylist('llm')" style="display: none;">▼</button>
                </div>
            </div>
            <div id="llmButtons" class="playlist-controls">
                <button onclick="discoverLlmPlaylist()">Fetch LLM Suggestions</button>
                <button onclick="downloadLlmPlaylist()" style="display: none;" class="download-btn">Download All Suggestions</button>
            </div>
            <div id="llmPlaylist" class="playlist-content"></div>
        </div>

        <div id="runNowSection" class="playlist-section" style="display: none; padding-top: 10px;">
            <button id="runNowBtn" onclick="runNow()" style="width: 100%; background-color: #3a3a5a; border: 1px solid var(--border-color); color: var(--text-color); font-size: 0.95em; padding: 10px;">
                Fetch All Recommendations Now
            </button>
        </div>

        <!-- Download Queue Section -->
        <div id="downloadQueueSection" class="playlist-section" style="display: none;">
            <div class="playlist-header">
                <h2>Download Queue</h2>
                <div>
                    <span id="downloadQueueStatus" class="playlist-status"></span>
                    <button id="downloadQueueToggle" class="playlist-toggle" onclick="togglePlaylist('downloadQueue')" style="display: none;">▼</button>
                </div>
            </div>
            <div id="downloadQueueContent" class="playlist-content">
                <p style="text-align: center; color: #b0b0b0;">No downloads in queue.</p>
            </div>
        </div>

    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSettingsModal()">&times;</span>
            <h2>Settings</h2>

            <!-- Configuration Section -->
            <div class="settings">
                <details>
                    <summary>Music Services</summary>
                    <div style="padding: 15px;">
                        <h3>ListenBrainz</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="listenbrainzEnabled"> Enable ListenBrainz
                            </label>
                        </div>
                        <div id="listenbrainzOptions" style="display: none; padding-left: 20px; border-left: 2px solid var(--border-color); margin-left: 5px;">
                            <div class="form-group">
                                <label for="listenbrainzUser">Username:</label>
                                <input type="text" id="listenbrainzUser" placeholder="Your ListenBrainz username">
                            </div>
                            <div class="form-group">
                                <label for="listenbrainzToken">
                                    Token:
                                    <span class="help-icon" title="Get your token from https://listenbrainz.org/profile/ → Edit Profile → API Keys → Generate new token">ℹ️</span>
                                </label>
                                <input type="text" id="listenbrainzToken" placeholder="Your ListenBrainz API token">
                            </div>
                        </div>

                        <h3>Last.fm</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="lastfmEnabled"> Enable Last.fm
                            </label>
                        </div>
                        <div id="lastfmOptions" style="display: none; padding-left: 20px; border-left: 2px solid var(--border-color); margin-left: 5px;">
                            <div class="form-group">
                                <label for="lastfmUsername">Username:</label>
                                <input type="text" id="lastfmUsername" placeholder="Your Last.fm username">
                            </div>
                            <div class="form-group">
                                <label for="lastfmPassword">
                                    Password:
                                    <span class="help-icon" title="Your Last.fm password for automatic authentication with session key retrieval">ℹ️</span>
                                </label>
                                <input type="password" id="lastfmPassword" placeholder="Your Last.fm password">
                            </div>
                            <div class="form-group">
                                <label for="lastfmApiKey">
                                    API Key:
                                    <span class="help-icon" title="Get your API key from https://www.last.fm/api/account/create → Create API account → Copy API key">ℹ️</span>
                                </label>
                                <input type="text" id="lastfmApiKey" placeholder="Your Last.fm API key">
                            </div>
                            <div class="form-group">
                                <label for="lastfmApiSecret">
                                    API Secret:
                                    <span class="help-icon" title="Get your API secret from https://www.last.fm/api/account/create → Create API account → Copy Shared secret">ℹ️</span>
                                </label>
                                <input type="text" id="lastfmApiSecret" placeholder="Your Last.fm API secret">
                            </div>
                        </div>

                        <button onclick="saveUserSettings()">Save Settings</button>
                    </div>
                </details>

                <details>
                    <summary>Automation</summary>
                    <div style="padding: 15px;">
                        <div class="form-group">
                            <label for="cronInput">Cron Schedule:</label>
                            <small style="color: #b0b0b0; display: block; margin-bottom: 8px;">
                                Set when the automatic download should run weekly.
                            </small>
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                <select id="cronHour" style="padding: 8px; border-radius: 4px; background-color: #3a3a5a; color: var(--text-color); border: 1px solid var(--border-color);">
                                    {% for hour in range(24) %}
                                    <option value="{{ hour }}" {% if hour == cron_hour %}selected{% endif %}>{{ "%02d"|format(hour) }}</option>
                                    {% endfor %}
                                </select>
                                :
                                <select id="cronMinute" style="padding: 8px; border-radius: 4px; background-color: #3a3a5a; color: var(--text-color); border: 1px solid var(--border-color);">
                                    {% for minute in range(0, 60, 5) %}
                                    <option value="{{ minute }}" {% if minute == cron_minute %}selected{% endif %}>{{ "%02d"|format(minute) }}</option>
                                    {% endfor %}
                                </select>
                                <select id="cronDay" style="padding: 8px; border-radius: 4px; background-color: #3a3a5a; color: var(--text-color); border: 1px solid var(--border-color);">
                                    <option value="0" {% if cron_day == 0 %}selected{% endif %}>Sunday</option>
                                    <option value="1" {% if cron_day == 1 %}selected{% endif %}>Monday</option>
                                    <option value="2" {% if cron_day == 2 %}selected{% endif %}>Tuesday</option>
                                    <option value="3" {% if cron_day == 3 %}selected{% endif %}>Wednesday</option>
                                    <option value="4" {% if cron_day == 4 %}selected{% endif %}>Thursday</option>
                                    <option value="5" {% if cron_day == 5 %}selected{% endif %}>Friday</option>
                                    <option value="6" {% if cron_day == 6 %}selected{% endif %}>Saturday</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label for="cronTimezone" style="font-size: 0.9em;">Timezone:</label>
                                <select id="cronTimezone" style="padding: 8px; border-radius: 4px; background-color: #3a3a5a; color: var(--text-color); border: 1px solid var(--border-color); width: 100%; margin-top: 4px;">
                                    {% for tz in timezones %}
                                    <option value="{{ tz }}" {% if tz == cron_timezone %}selected{% endif %}>{{ tz }}</option>
                                    {% endfor %}
                                </select>
                                <small style="color: #b0b0b0; display: block; margin-top: 4px;">
                                    Select your local timezone. The schedule will be converted to UTC for the container.
                                </small>
                            </div>
                            <input type="hidden" id="cronInput" value="{{ cron_schedule }}">
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="disableCron" {% if not cron_enabled %}checked{% endif %}>
                                Disable Automatic Downloads
                            </label>
                        </div>

                        <button onclick="saveAutomationOptions()">Save Automation Options</button>

                        <hr style="border-color: var(--border-color); margin: 20px 0;">

                        <h3 style="margin-bottom: 8px;">Monitored Playlists</h3>
                        <small style="color: #b0b0b0; display: block; margin-bottom: 12px;">
                            Playlists below are automatically checked for new tracks at their configured interval.
                        </small>
                        <div id="monitoredPlaylistsList" class="mp-list">
                            <p style="color: #666; font-size: 0.9em;">Loading...</p>
                        </div>
                    </div>
                </details>

                <details>
                    <summary>Mobile Apps</summary>
                    <div style="padding: 15px;">
                        <h3>Android</h3>
                        <p style="color: #b0b0b0; margin-bottom: 10px;">Install this site as a PWA (Progressive Web App) to share links directly:</p>
                        <ol style="color: #b0b0b0; margin-left: 20px; margin-bottom: 15px;">
                            <li>In Chrome, tap the menu (⋮) and select "Add to Home screen"</li>
                            <li>Once installed, share any music link and select TrackDrop from the share sheet</li>
                        </ol>

                        <h3>iOS (iPhone/iPad)</h3>
                        <p style="color: #b0b0b0; margin-bottom: 10px;">Use iOS Shortcuts to share links directly to TrackDrop:</p>
                        <a href="/ios-shortcut" target="_blank" style="display: inline-block; background: var(--primary-color); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; margin-bottom: 10px;">Set Up iOS Shortcut</a>
                        <p style="color: #888; font-size: 0.85em;">Opens a page with setup instructions and your personal API key.</p>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <!-- First-time Setup Wizard -->
    <div id="setupWizard" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 550px;">
            <h2 style="color: var(--primary-color); margin-bottom: 10px;">Welcome to TrackDrop, {{ username }}!</h2>
            <p style="color: #b0b0b0; margin-bottom: 20px;">Let's set up your music recommendation sources. You can always change these later in Settings.</p>

            <div id="wizardStep1">
                <h3 style="color: var(--secondary-color);">ListenBrainz</h3>
                <p style="color: #b0b0b0; font-size: 0.9em; margin-bottom: 10px;">Get weekly personalized recommendations based on your listening history.</p>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="wizardLbEnabled"> Enable ListenBrainz
                    </label>
                </div>
                <div id="wizardLbOptions" style="display: none; padding-left: 20px; border-left: 2px solid var(--border-color); margin-left: 5px;">
                    <div class="form-group">
                        <label for="wizardLbUser">Username:</label>
                        <input type="text" id="wizardLbUser" placeholder="Your ListenBrainz username">
                    </div>
                    <div class="form-group">
                        <label for="wizardLbToken">Token:</label>
                        <input type="text" id="wizardLbToken" placeholder="Your ListenBrainz API token">
                        <small style="color: #b0b0b0; display: block; margin-top: 5px;">Get from listenbrainz.org/profile/ → API Keys</small>
                    </div>
                </div>

                <hr style="border-color: var(--border-color); margin: 20px 0;">

                <h3 style="color: var(--secondary-color);">Last.fm</h3>
                <p style="color: #b0b0b0; font-size: 0.9em; margin-bottom: 10px;">Get recommendations from Last.fm's weekly playlist.</p>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="wizardLfEnabled"> Enable Last.fm
                    </label>
                </div>
                <div id="wizardLfOptions" style="display: none; padding-left: 20px; border-left: 2px solid var(--border-color); margin-left: 5px;">
                    <div class="form-group">
                        <label for="wizardLfUsername">Username:</label>
                        <input type="text" id="wizardLfUsername" placeholder="Your Last.fm username">
                    </div>
                    <div class="form-group">
                        <label for="wizardLfPassword">Password:</label>
                        <input type="password" id="wizardLfPassword" placeholder="Your Last.fm password">
                    </div>
                    <div class="form-group">
                        <label for="wizardLfApiKey">API Key:</label>
                        <input type="text" id="wizardLfApiKey" placeholder="Your Last.fm API key">
                        <small style="color: #b0b0b0; display: block; margin-top: 5px;">Get from last.fm/api/account/create</small>
                    </div>
                    <div class="form-group">
                        <label for="wizardLfApiSecret">API Secret:</label>
                        <input type="text" id="wizardLfApiSecret" placeholder="Your Last.fm API secret">
                    </div>
                </div>

                <hr style="border-color: var(--border-color); margin: 20px 0;">

                <h3 style="color: var(--secondary-color);">Mobile App</h3>
                <p style="color: #b0b0b0; font-size: 0.9em; margin-bottom: 10px;">Share music links directly from your phone to download them instantly.</p>

                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px; background: #1a1a2e; padding: 12px; border-radius: 8px;">
                        <strong style="color: #4CAF50;">Android</strong>
                        <p style="color: #888; font-size: 0.85em; margin-top: 5px;">Tap menu (⋮) → "Add to Home screen" to install as an app.</p>
                    </div>
                    <div style="flex: 1; min-width: 200px; background: #1a1a2e; padding: 12px; border-radius: 8px;">
                        <strong style="color: #007AFF;">iOS</strong>
                        <p style="color: #888; font-size: 0.85em; margin-top: 5px;">
                            <a href="/ios-shortcut" target="_blank" style="color: var(--primary-color);">Set up iOS Shortcut</a> to share links from any app.
                        </p>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="completeSetupWizard()" style="flex: 1;">Save & Get Started</button>
                    <button onclick="skipSetupWizard()" style="flex: 1; background-color: #3a3a5a;">Skip for Now</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Queue Panel -->
    <div id="downloadQueuePanel" class="download-queue-modal">
        <svg class="close-btn-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" onclick="closeDownloadQueuePanel()">
            <path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div class="modal-content">
            <h2>Download Queue</h2>
            <div id="downloadQueueModalContent" style="flex-grow: 1; overflow-y: auto;">
                <p style="text-align: center; color: #b0b0b0;">No downloads in queue.</p>
            </div>
        </div>
    </div>

    <!-- Playlist download mode popup -->
    <div id="playlistModeOverlay" class="pl-popup-overlay">
        <div class="pl-popup">
            <h3>Download Playlist</h3>
            <p id="playlistModeName" style="font-weight: 500; margin-bottom: 4px;"></p>
            <p id="playlistModeUrl" style="font-size: 0.8em; color: #888; word-break: break-all;"></p>
            <p id="playlistModeTrackCount" style="font-size: 0.85em; color: #b0b0b0; margin-bottom: 12px;"></p>

            <!-- Duplicate name warning -->
            <div id="playlistDuplicateSection" style="display: none; margin-bottom: 14px; padding: 10px; background: rgba(255,170,0,0.1); border-radius: 8px; border: 1px solid rgba(255,170,0,0.3);">
                <p style="color: #ffa600; font-size: 0.9em; margin: 0 0 8px;">A playlist with this name already exists in Navidrome.</p>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <label style="font-size: 0.85em; cursor: pointer;">
                        <input type="radio" name="playlistDuplicateAction" value="overwrite" checked> Overwrite existing
                    </label>
                    <label style="font-size: 0.85em; cursor: pointer;">
                        <input type="radio" name="playlistDuplicateAction" value="rename"> Use different name
                    </label>
                </div>
                <input type="text" id="playlistRenameInput" style="display: none; width: 100%; padding: 8px; border-radius: 4px; background: #3a3a5a; color: var(--text-color); border: 1px solid var(--border-color); box-sizing: border-box;" placeholder="Enter new playlist name">
            </div>

            <div class="pl-popup-btns">
                <button class="btn-monitor" onclick="submitPlaylistDownload(true)">
                    Download &amp; Monitor for new tracks
                </button>
                <button class="btn-once" onclick="submitPlaylistDownload(false)">
                    Download once
                </button>
            </div>
            <div id="playlistIntervalSection" class="pl-popup-interval">
                <label>Check for new tracks every:
                    <select id="playlistPollInterval">
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24" selected>24 hours</option>
                        <option value="48">2 days</option>
                        <option value="168">Weekly</option>
                    </select>
                </label>
            </div>
        </div>
    </div>

    <script>
        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            loadUserSettings();
            loadConfiguration();
            loadMonitoredPlaylists();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function openDownloadQueueModal() {
            const downloadQueuePanel = document.getElementById('downloadQueuePanel');
            if (downloadQueuePanel.classList.contains('open')) {
                closeDownloadQueuePanel(); // Close if already open
            } else {
                downloadQueuePanel.classList.add('open');
                document.body.classList.add('download-queue-panel-open'); // Add class to body
                fetchDownloadQueueStatus(); // Load queue status when panel opens
            }
        }

        function closeDownloadQueuePanel() {
            document.getElementById('downloadQueuePanel').classList.remove('open');
            document.body.classList.remove('download-queue-panel-open'); // Remove class from body
        }

        // Functions to toggle visibility of dependent settings
        function updateListenBrainzVisibility() {
            const isEnabled = document.getElementById('listenbrainzEnabled').checked;
            document.getElementById('listenbrainzOptions').style.display = isEnabled ? 'block' : 'none';
        }

        function updateLastFmVisibility() {
            const isEnabled = document.getElementById('lastfmEnabled').checked;
            document.getElementById('lastfmOptions').style.display = isEnabled ? 'block' : 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('listenbrainzEnabled').addEventListener('change', updateListenBrainzVisibility);
            document.getElementById('lastfmEnabled').addEventListener('change', updateLastFmVisibility);

            // Setup wizard toggles
            const wizLb = document.getElementById('wizardLbEnabled');
            if (wizLb) wizLb.addEventListener('change', () => {
                document.getElementById('wizardLbOptions').style.display = wizLb.checked ? 'block' : 'none';
            });
            const wizLf = document.getElementById('wizardLfEnabled');
            if (wizLf) wizLf.addEventListener('change', () => {
                document.getElementById('wizardLfOptions').style.display = wizLf.checked ? 'block' : 'none';
            });
        });        // Close modals when clicking outside of them
        window.onclick = function(event) {
            const settingsModal = document.getElementById('settingsModal');
            // Check if settings modal needs to be closed
            if (event.target == settingsModal) {
                settingsModal.style.display = 'none';
            }
            // Removed logic to close downloadQueuePanel on outside click as per user feedback.
            // Only the queue button should close it now.
        }

        function togglePlaylist(service) {
            const contentDiv = document.getElementById(`${service}Playlist`);
            const toggleBtn = document.getElementById(`${service}Toggle`);
            if (contentDiv.classList.contains('collapsed')) {
                contentDiv.classList.remove('collapsed');
                toggleBtn.textContent = '▼';
            } else {
                contentDiv.classList.add('collapsed');
                toggleBtn.textContent = '▶';
            }
        }


async function triggerNavidromeCleanup() {
    const response = await fetch('/api/trigger_navidrome_cleanup', {
        method: 'POST'
    });
    const data = await response.json();
    showMessage(data.status, data.message);

    // Log debug information to console
    if (data.debug_info) {
        console.groupCollapsed('Deezer API Debug Info (Fresh Release Download)');
        console.log('Album Info Sent:', data.debug_info.album_info_sent);
        console.log('Download Result:', data.debug_info.download_result);
        if (data.debug_info.error_traceback) {
            console.error('Error Traceback:', data.debug_info.error_traceback);
        }
        console.groupEnd();
    }
}

async function createSmartPlaylists() {
    const button = event.target;
    const originalContent = button.innerHTML;

    // Update button to show loading state
    button.innerHTML = '<div class="spinner"></div>Creating...';
    button.disabled = true;

    try {
        const response = await fetch('/api/create_smart_playlists', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (data.status === 'success') {
            showMessage('success', data.message);
            console.log('Smart playlists created:', data.created_files);
            if (data.failed_files && data.failed_files.length > 0) {
                console.warn('Failed to create some playlists:', data.failed_files);
            }
        } else {
            showMessage('error', data.message);
            console.error('Error creating smart playlists:', data.failed_files);
        }
    } catch (error) {
        console.error('Network error creating smart playlists:', error);
        showMessage('error', 'Failed to create smart playlists: ' + error.message);
    } finally {
        // Reset button after a delay
        setTimeout(() => {
            button.innerHTML = originalContent;
            button.disabled = false;
        }, 2000);
    }
}

        // --- Download Queue Functions ---
        const downloadQueue = []; // In-memory queue for display
        let downloadQueueInterval = null;

        // Track which track lists are expanded (persists across re-renders)
        const expandedItems = new Set();

        function _statusIcon(status, size = 24) {
            if (status === 'in_progress') return `<div class="spinner" style="width:${size}px;height:${size}px;"></div>`;
            if (status === 'completed' || status === 'skipped') return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none"><path d="M4 12.6111L8.92308 17.5L20 6.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            if (status === 'failed') return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            if (status === 'pending') return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="3" fill="#666"/></svg>`;
            return '';
        }

        function _trackStatusColor(status) {
            if (status === 'completed') return 'var(--success-color)';
            if (status === 'skipped') return 'var(--secondary-color)';
            if (status === 'failed') return 'var(--error-color)';
            if (status === 'in_progress') return 'var(--info-color)';
            return '#666';
        }

        function _escHtml(s) {
            const d = document.createElement('div');
            d.textContent = s || '';
            return d.innerHTML;
        }

        function toggleTrackList(itemId) {
            if (expandedItems.has(itemId)) expandedItems.delete(itemId);
            else expandedItems.add(itemId);
            updateDownloadQueueUI();
        }

        function renderPlaylistItem(item) {
            const tracks = item.tracks || [];
            const total = item.total_track_count || tracks.length || 0;
            const dl = item.downloaded_count || 0;
            const skip = item.skipped_count || 0;
            const fail = item.failed_count || 0;
            const processed = dl + skip + fail;
            const pending = Math.max(0, total - processed);
            const pct = total > 0 ? Math.round((processed / total) * 100) : 0;
            const isExpanded = expandedItems.has(item.id);

            // Progress bar color: green if completed, blue if in progress, red if failed
            let barColor = 'var(--info-color)';
            if (item.status === 'completed') barColor = 'var(--success-color)';
            else if (item.status === 'failed') barColor = 'var(--error-color)';

            let trackListHtml = '';
            if (tracks.length > 0) {
                trackListHtml = `
                    <button class="dq-expand-btn" onclick="toggleTrackList('${item.id}')">
                        ${isExpanded ? '▼ Hide tracks' : '▶ Show tracks (' + tracks.length + ')'}
                    </button>
                    <div class="dq-track-list ${isExpanded ? 'open' : ''}" data-item-id="${item.id}">
                        ${tracks.map(t => `
                            <div class="dq-track-entry">
                                <span class="dq-track-status-icon" style="color: ${_trackStatusColor(t.status)}">${_statusIcon(t.status, 14)}</span>
                                <span class="dq-track-label">${_escHtml(t.artist)} - ${_escHtml(t.title)}</span>
                                <span class="dq-track-msg">${_escHtml(t.message)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            return `
                <div class="download-queue-item ${item.status}">
                    <div class="download-queue-item-header">
                        <div class="track-info">
                            <div class="track-title">${_escHtml(item.title)}</div>
                            ${item.message ? `<div style="font-size: 0.85em; margin-top: 3px; color: ${item.status === 'failed' ? 'var(--error-color)' : item.status === 'completed' ? 'var(--success-color)' : '#b0b0b0'}">${_escHtml(item.message)}</div>` : ''}
                        </div>
                        <div class="status-icon ${item.status}">
                            ${_statusIcon(item.status)}
                        </div>
                    </div>
                    ${total > 0 ? `
                        <div class="dq-progress-bar">
                            <div class="dq-progress-bar-inner" style="width: ${pct}%; background-color: ${barColor};"></div>
                        </div>
                        <div class="dq-stats">
                            ${dl > 0 ? `<span class="dq-stat"><span class="dq-stat-dot downloaded"></span>${dl} downloaded</span>` : ''}
                            ${skip > 0 ? `<span class="dq-stat"><span class="dq-stat-dot skipped"></span>${skip} in library</span>` : ''}
                            ${fail > 0 ? `<span class="dq-stat"><span class="dq-stat-dot failed"></span>${fail} failed</span>` : ''}
                            ${pending > 0 && item.status === 'in_progress' ? `<span class="dq-stat"><span class="dq-stat-dot pending"></span>${pending} remaining</span>` : ''}
                        </div>
                    ` : ''}
                    ${trackListHtml}
                </div>
            `;
        }

        function renderSimpleItem(item) {
            return `
                <div class="download-queue-item ${item.status}">
                    <div class="download-queue-item-header">
                        <div class="track-info">
                            <div class="track-title">${_escHtml(item.title)}</div>
                            <div class="track-artist">${_escHtml(item.artist)}</div>
                            ${item.message ? `<div style="font-size: 0.85em; margin-top: 3px; color: ${item.status === 'failed' ? 'var(--error-color)' : item.status === 'completed' ? 'var(--success-color)' : '#b0b0b0'}">${_escHtml(item.message)}</div>` : ''}
                        </div>
                        <div class="status-icon ${item.status}">
                            ${_statusIcon(item.status)}
                        </div>
                    </div>
                </div>
            `;
        }

        function updateDownloadQueueUI() {
            const queueContent = document.getElementById('downloadQueueModalContent');
            if (!queueContent) return;

            // Preserve scroll positions before re-render
            const mainScroll = queueContent.scrollTop;
            const trackListScrolls = {};
            queueContent.querySelectorAll('.dq-track-list').forEach(el => {
                if (el.scrollTop > 0 && el.dataset.itemId) {
                    trackListScrolls[el.dataset.itemId] = el.scrollTop;
                }
            });

            if (downloadQueue.length === 0) {
                queueContent.innerHTML = '<p style="text-align: center; color: #b0b0b0;">No downloads in queue.</p>';
            } else {
                queueContent.innerHTML = downloadQueue.map(item => {
                    if (item.download_type === 'playlist' || (item.tracks && item.tracks.length > 0)) {
                        return renderPlaylistItem(item);
                    }
                    return renderSimpleItem(item);
                }).join('');
            }

            // Restore scroll positions after re-render
            queueContent.scrollTop = mainScroll;
            queueContent.querySelectorAll('.dq-track-list').forEach(el => {
                if (el.dataset.itemId && trackListScrolls[el.dataset.itemId]) {
                    el.scrollTop = trackListScrolls[el.dataset.itemId];
                }
            });
        }

        async function fetchDownloadQueueStatus() {
            try {
                const response = await fetch('/api/download_queue');
                const data = await response.json();
                if (data.status === 'success') {
                    // Clear existing queue and repopulate, include message for failed items
                    downloadQueue.length = 0;
                    data.queue.forEach(item => downloadQueue.push({ ...item, message: item.message || '' }));
                    updateDownloadQueueUI();
                } else {
                    console.error('Failed to fetch download queue:', data.message);
                }
            } catch (error) {
                console.error('Network error fetching download queue:', error);
            }
        }

        // Start polling the download queue when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchDownloadQueueStatus(); // Initial fetch immediately
            downloadQueueInterval = setInterval(fetchDownloadQueueStatus, 3000); // Poll every 3 seconds
        });

        function showMessage(type, text) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${type}`;
            messageDiv.innerText = text;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        function applyTemporaryFeedbackStyle(buttonElement, status) {
            const iconElement = buttonElement.querySelector('.feedback-icon');
            if (!iconElement) return;

            const className = status === 'success' ? 'success-feedback' : 'error-feedback';
            iconElement.classList.add(className);

            setTimeout(() => {
                iconElement.classList.remove(className);
            }, 1000); // Remove the style after 1 second
        }

        async function updateArl() {
            const arl = document.getElementById('arlInput').value;
            const response = await fetch('/api/update_arl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ arl: arl })
            });
            const data = await response.json();
            showMessage(data.status, data.message);
        }

        async function updateCron() {
            const hour = document.getElementById('cronHour').value;
            const minute = document.getElementById('cronMinute').value;
            const day = document.getElementById('cronDay').value;
            const timezone = document.getElementById('cronTimezone').value;
            // Build cron schedule: "MINUTE HOUR * * DAY"
            const schedule = `${minute} ${hour} * * ${day}`;
            const response = await fetch('/api/update_cron', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ schedule: schedule, timezone: timezone })
            });
            const data = await response.json();
            showMessage(data.status, data.message);
        }

        async function toggleCronDisable() {
            const disabled = document.getElementById('disableCron').checked;
            const response = await fetch('/api/toggle_cron', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ disabled: disabled })
            });
            const data = await response.json();
            showMessage(data.status, data.message);
        }

        let llmAbortController = null; // Global variable to store the abort controller

        async function discoverLlmPlaylist() {
            const playlistDiv = document.getElementById('llmPlaylist');
            const statusDiv = document.getElementById('llmStatus');
            const toggleBtn = document.getElementById('llmToggle');

            // Cancel any existing request
            if (llmAbortController) {
                llmAbortController.abort();
            }

            // Create new abort controller for this request
            llmAbortController = new AbortController();

            playlistDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100px;"><div class="spinner" style="margin-right: 8px;"></div><span>Querying the LLM for recommendations... (this can take a while)</span><button id="cancelLlmBtn" style="margin-left: 15px; padding: 5px 10px; background-color: var(--error-color); color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="cancelLlmQuery()">Cancel</button></div>';
            statusDiv.textContent = '';
            toggleBtn.style.display = 'none';

            try {
                const response = await fetch('/api/get_llm_playlist', {
                    signal: llmAbortController.signal
                });
                const data = await response.json();

                if (data.status === 'success' && data.recommendations.length > 0) {
                    playlistDiv.innerHTML = data.recommendations.map((song, index) => {
                        const caaReleaseMbid = song.caa_release_mbid || '';
                        const caaId = song.caa_id || '';
                        return `<div class="playlist-item">
                            <div class="album-art-container">
                                <img src="/assets/default-album.svg" alt="Album Art" class="album-art" 
                                     id="llm-album-art-${index}" 
                                     data-caa-release-mbid="${caaReleaseMbid}" 
                                     data-caa-id="${caaId}"
                                     data-artist="${song.artist.replace(/"/g, '&quot;')}" data-album="${song.album.replace(/"/g, '&quot;')}">
                                <div class="album-art-spinner"></div>
                            </div>
                            <div class="track-info">
                                <div class="track-title">${song.title}</div>
                                <div class="track-artist">${song.artist}</div>
                                <div class="track-album">${song.album}</div>
                            </div>
                            <div class="feedback-buttons">
                                <button class="feedback-btn play-btn" onclick="playTrackPreview('${song.artist.replace(/'/g, "\\'")}', '${song.title.replace(/'/g, "\\'")}', this)" title="Play preview">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="feedback-icon">
                                        <path d="M5 3L19 12L5 21V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="feedback-btn download-btn" onclick="downloadIndividualTrack('${song.artist.replace(/'/g, "\\'")}', '${song.title.replace(/'/g, "\\'")}', this, false, 'LLM')" title="Download track">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="feedback-icon"><path d="M17 17H17.01M17.4 14H18C18.9319 14 19.3978 14 19.7654 14.1522C20.2554 14.3552 20.6448 14.7446 20.8478 15.2346C21 15.6022 21 16.0681 21 17C21 17.9319 21 18.3978 20.8478 18.7654C20.6448 19.2554 20.2554 19.6448 19.7654 19.8478C19.3978 20 18.9319 20 18 20H6C5.06812 20 4.60218 20 4.23463 19.8478C3.74458 19.6448 3.35523 19.2554 3.15224 18.7654C3 18.3978 3 17.9319 3 17C3 16.0681 3 15.6022 3.15224 15.2346C3.35523 14.7446 3.74458 14.3552 4.23463 14.1522C4.60218 14 5.06812 14 6 14H6.6M12 15V4M12 15L9 12M12 15L15 12" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                                <button class="feedback-btn like-btn" onclick="submitListenBrainzFeedback(this, '${song.recording_mbid || 'null'}', 1)" title="Like this track on ListenBrainz">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="feedback-icon">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 6.00019C10.2006 3.90317 7.19377 3.2551 4.93923 5.17534C2.68468 7.09558 2.36727 10.3061 4.13778 12.5772C5.60984 14.4654 10.0648 18.4479 11.5249 19.7369C11.6882 19.8811 11.7699 19.9532 11.8652 19.9815C11.9483 20.0062 12.0393 20.0062 12.1225 19.9815C12.2178 19.9532 12.2994 19.8811 12.4628 19.7369C13.9229 18.4479 18.3778 14.4654 19.8499 12.5772C21.6204 10.3061 21.3417 7.07538 19.0484 5.17534C16.7551 3.2753 13.7994 3.90317 12 6.00019Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="feedback-btn dislike-btn" onclick="submitListenBrainzFeedback(this, '${song.recording_mbid || 'null'}', -1)" title="Dislike this track on ListenBrainz">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="feedback-icon">
                                        <path d="M12 6.00011L14 8.00011L10 10.0001L13 13.0001M12 6.00011C10.2006 3.90309 7.19377 3.25515 4.93923 5.17539C2.68468 7.09563 2.36727 10.3062 4.13778 12.5772C5.60984 14.4655 10.0648 18.4479 11.5249 19.7369C11.6882 19.8811 11.7699 19.9532 11.8652 19.9816C11.9483 20.0063 12.0393 20.0063 12.1225 19.9816C12.2178 19.9532 12.2994 19.8811 12.4628 19.7369C13.9229 18.4479 18.3778 14.4655 19.8499 12.5772C21.6204 10.3062 21.3417 7.07543 19.0484 5.17539C16.7551 3.27535 13.7994 3.90309 12 6.00011Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>`;
                    }).join('');
                    document.getElementById('llmButtons').innerHTML = '<button class="download-btn" id="llmDownloadBtn" onclick="downloadLlmPlaylist()">Download All</button><button onclick="discoverLlmPlaylist()">Get New Suggestions</button>';
                    statusDiv.textContent = `${data.recommendations.length} songs recommended by LLM.`;
                    toggleBtn.style.display = 'inline-block';
                    lazyLoadAlbumArts('llmPlaylist');
                } else {
                    playlistDiv.innerHTML = `<div class="playlist-item">${data.message}</div>`;
                    statusDiv.textContent = 'No recommendations found';
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    playlistDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100px;"><span>LLM query cancelled</span></div>';
                    statusDiv.textContent = 'Query cancelled';
                } else {
                    playlistDiv.innerHTML = `<div class="playlist-item">Network error: ${error.message}</div>`;
                    statusDiv.textContent = 'Network error';
                }
            }
        }

        function cancelLlmQuery() {
            if (llmAbortController) {
                llmAbortController.abort();
                showMessage('info', 'LLM query cancelled');
            }
        }

        async function downloadLlmPlaylist() {
            showMessage('info', 'LLM playlist download started...');
            const response = await fetch('/api/trigger_llm_download', { method: 'POST' });
            const data = await response.json();
            showMessage(data.status, data.message);
        }

        async function discoverListenBrainzPlaylist() {
            await getListenBrainzPlaylist(true);
        }

        async function refetchListenBrainzPlaylist() {
            await getListenBrainzPlaylist(false);
        }

        async function getListenBrainzPlaylist(isDiscover = false) {
            const playlistDiv = document.getElementById('listenBrainzPlaylist');
            const statusDiv = document.getElementById('listenBrainzStatus');
            const toggleBtn = document.getElementById('listenBrainzToggle');
            playlistDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100px;"><div class="spinner" style="margin-right: 8px;"></div><span>Loading...</span></div>';
            statusDiv.textContent = '';
            toggleBtn.style.display = 'none';
            try {
                const response = await fetch('/api/get_listenbrainz_playlist');
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (jsonError) {
                    playlistDiv.innerHTML = `<div class="playlist-item">Error: ${response.status} ${response.statusText}<br><pre>${text}</pre></div>`;
                    statusDiv.textContent = 'Error loading playlist';
                    showMessage('error', `API returned non-JSON response: ${response.status}`);
                    return;
                }
                if (data.status === 'success' && data.recommendations.length > 0) {
                    playlistDiv.innerHTML = data.recommendations.map((song, index) => {
                        const recordingMbid = song.recording_mbid || 'null';
                        const caaReleaseMbid = song.caa_release_mbid || '';
                        const caaId = song.caa_id || '';
                        
                        // Default album art, will be replaced by lazy loading
                        const albumArtSrc = '/assets/default-album.svg';

                        return `<div class="playlist-item">
                            <div class="album-art-container">
                                <img src="${albumArtSrc}" alt="Album Art" class="album-art" 
                                     id="lb-album-art-${index}" 
                                     data-caa-release-mbid="${caaReleaseMbid}" 
                                     data-caa-id="${caaId}"
                                     data-artist="${song.artist.replace(/"/g, '&quot;')}"
                                     data-album="${song.album.replace(/"/g, '&quot;')}">
                                <div class="album-art-spinner"></div>
                            </div>
                            <div class="track-info">
                                <div class="track-title">${song.title}</div>
                                <div class="track-artist">${song.artist}</div>
                                <div class="track-album">${song.album}</div>
                            </div>
                            <div class="feedback-buttons">
                                <button class="feedback-btn play-btn" onclick="playTrackPreview('${song.artist.replace(/'/g, "\\'")}', '${song.title.replace(/'/g, "\\'")}', this)" title="Play preview">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="feedback-icon">
                                        <path d="M5 3L19 12L5 21V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="feedback-btn download-btn" onclick="downloadIndividualTrack('${song.artist.replace(/'/g, "\\'")}', '${song.title.replace(/'/g, "\\'")}', this, true, 'ListenBrainz')" title="Download track">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="feedback-icon">
                                        <path d="M17 17H17.01M17.4 14H18C18.9319 14 19.3978 14 19.7654 14.1522C20.2554 14.3552 20.6448 14.7446 20.8478 15.2346C21 15.6022 21 16.0681 21 17C21 17.9319 21 18.3978 20.8478 18.7654C20.6448 19.2554 20.2554 19.6448 19.7654 19.8478C19.3978 20 18.9319 20 18 20H6C5.06812 20 4.60218 20 4.23463 19.8478C3.74458 19.6448 3.35523 19.2554 3.15224 18.7654C3 18.3978 3 17.9319 3 17C3 16.0681 3 15.6022 3.15224 15.2346C3.35523 14.7446 3.74458 14.3552 4.23463 14.1522C4.60218 14 5.06812 14 6 14H6.6M12 15V4M12 15L9 12M12 15L15 12" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>                                    </svg>
                                </button>
                                <button class="feedback-btn like-btn" onclick="submitListenBrainzFeedback(this, '${recordingMbid}', 1)" title="Like this track">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="feedback-icon">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 6.00019C10.2006 3.90317 7.19377 3.2551 4.93923 5.17534C2.68468 7.09558 2.36727 10.3061 4.13778 12.5772C5.60984 14.4654 10.0648 18.4479 11.5249 19.7369C11.6882 19.8811 11.7699 19.9532 11.8652 19.9815C11.9483 20.0062 12.0393 20.0062 12.1225 19.9815C12.2178 19.9532 12.2994 19.8811 12.4628 19.7369C13.9229 18.4479 18.3778 14.4654 19.8499 12.5772C21.6204 10.3061 21.3417 7.07538 19.0484 5.17534C16.7551 3.2753 13.7994 3.90317 12 6.00019Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="feedback-btn dislike-btn" onclick="submitListenBrainzFeedback(this, '${recordingMbid}', -1)" title="Dislike this track">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="feedback-icon">
                                        <path d="M12 6.00011L14 8.00011L10 10.0001L13 13.0001M12 6.00011C10.2006 3.90309 7.19377 3.25515 4.93923 5.17539C2.68468 7.09563 2.36727 10.3062 4.13778 12.5772C5.60984 14.4655 10.0648 18.4479 11.5249 19.7369C11.6882 19.8811 11.7699 19.9532 11.8652 19.9816C11.9483 20.0063 12.0393 20.0063 12.1225 19.9816C12.2178 19.9532 12.2994 19.8811 12.4628 19.7369C13.9229 18.4479 18.3778 14.4655 19.8499 12.5772C21.6204 10.3062 21.3417 7.07543 19.0484 5.17539C16.7551 3.27535 13.7994 3.90309 12 6.00011Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>`;
                    }).join('');
                    if (isDiscover) {
                        document.getElementById('listenBrainzButtons').innerHTML = '<button class="download-btn" id="listenBrainzDownloadBtn" onclick="downloadListenBrainzPlaylist()">Download all</button><button onclick="refetchListenBrainzPlaylist()">Refetch</button>';
                    }
                    // Setup intersection observer for lazy loading album art
                    statusDiv.textContent = `${data.recommendations.length} songs fetched from ListenBrainz`;
                    toggleBtn.style.display = 'inline-block';
                    showMessage('info', `Found ${data.recommendations.length} ListenBrainz recommendations.`);
                } else {
                    playlistDiv.innerHTML = `<div class="playlist-item">${data.message}</div>`;
                    statusDiv.textContent = 'No recommendations found';
                    showMessage(data.status, data.message);
                }
                // Call lazy load function for all album arts after rendering
                lazyLoadAlbumArts('listenBrainzPlaylist');
            } catch (error) {
                playlistDiv.innerHTML = `<div class="playlist-item">Network error: ${error.message}</div>`;
                statusDiv.textContent = 'Network error';
                showMessage('error', `Network error: ${error.message}`);
            }
        }

        async function downloadListenBrainzPlaylistDirect() {
            const response = await fetch('/api/trigger_listenbrainz_download', {
                method: 'POST'
            });
            const data = await response.json();
            showMessage(data.status, data.message);
        }

        async function downloadListenBrainzPlaylist() {
            const downloadBtn = document.getElementById('listenBrainzDownloadBtn');
            downloadBtn.innerHTML = '<div class="spinner" style="margin-right: 8px;"></div>Downloading...';
            downloadBtn.disabled = true;

            // Show immediate feedback message
            showMessage('info', 'Download started...');
            // Add to client-side queue display immediately
            const downloadId = `listenbrainz-${Date.now()}`;
            downloadQueue.push({ id: downloadId, artist: 'ListenBrainz Playlist', title: 'Multiple Tracks', status: 'in_progress' });
            updateDownloadQueueUI();

            const response = await fetch('/api/trigger_listenbrainz_download', {
                method: 'POST'
            });
            const data = await response.json();
            // The polling function will update the actual status
            setTimeout(() => {
                downloadBtn.innerHTML = 'Download all';
                downloadBtn.disabled = false;
                showMessage(data.status, data.message);
            }, 2000);
        }

        async function discoverLastFmPlaylist() {
            await getLastFmPlaylist(true);
        }

        async function refetchLastFmPlaylist() {
            await getLastFmPlaylist(false);
        }

        async function getLastFmPlaylist(isDiscover = false) {
            const playlistDiv = document.getElementById('lastFmPlaylist');
            const statusDiv = document.getElementById('lastFmStatus');
            const toggleBtn = document.getElementById('lastFmToggle');
            playlistDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100px;"><div class="spinner" style="margin-right: 8px;"></div><span>Loading...</span></div>';
            statusDiv.textContent = '';
            toggleBtn.style.display = 'none';
            try {
                const response = await fetch('/api/get_lastfm_playlist');
                const data = await response.json();
                if (data.status === 'success' && data.recommendations.length > 0) {
                    playlistDiv.innerHTML = data.recommendations.map((song, index) => {
                        const albumArtSrc = song.album_art || '/assets/default-album.svg';
                        const albumArtLoadedClass = song.album_art ? 'loaded' : ''; // Add 'loaded' class if art is pre-fetched
                        const spinnerDisplay = song.album_art ? 'none' : 'block'; // Hide spinner if art is pre-fetched

                        return `<div class="playlist-item">
                            <div class="album-art-container">
                                <img src="${albumArtSrc}" alt="Album Art" class="album-art ${albumArtLoadedClass}" id="lf-album-art-${index}" data-artist="${song.artist.replace(/"/g, '&quot;')}" data-album="${song.album.replace(/"/g, '&quot;')}" data-title="${song.title.replace(/"/g, '&quot;')}">
                                <div class="album-art-spinner" style="display: ${spinnerDisplay};"></div>
                            </div>
                            <div class="track-info">
                                <div class="track-title">${song.title}</div>
                                <div class="track-artist">${song.artist}</div>
                                <div class="track-album">${song.album}</div>
                            </div>
                            <div class="feedback-buttons">
                                <button class="feedback-btn play-btn" onclick="playTrackPreview('${song.artist.replace(/'/g, "\\'")}', '${song.title.replace(/'/g, "\\'")}', this)" title="Play preview">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="feedback-icon">
                                        <path d="M5 3L19 12L5 21V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="feedback-btn download-btn" onclick="downloadIndividualTrack('${song.artist.replace(/'/g, "\\'")}', '${song.title.replace(/'/g, "\\'")}', this, false, 'Last.fm')" title="Download track">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="feedback-icon">
                                        <path d="M17 17H17.01M17.4 14H18C18.9319 14 19.3978 14 19.7654 14.1522C20.2554 14.3552 20.6448 14.7446 20.8478 15.2346C21 15.6022 21 16.0681 21 17C21 17.9319 21 18.3978 20.8478 19.8478C20.6448 19.2554 20.2554 19.6448 19.7654 19.8478C19.3978 20 18.9319 20 18 20H6C5.06812 20 4.60218 20 4.23463 19.8478C3.74458 19.6448 3.35523 19.2554 3.15224 19.2346C3 18.6022 3 18.0681 3 17C3 16.0681 3 15.6022 3.15224 15.2346C3.35523 14.7446 3.74458 14.3552 4.23463 14.1522C4.60218 14 5.06812 14 6 14H6.6M12 15V4M12 15L9 12M12 15L15 12" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>                                    </svg>
                                </button>
                                <button class="feedback-btn like-btn" onclick="submitLastFmFeedback(this, '${song.title.replace(/'/g, "\\'")}', '${song.artist.replace(/'/g, "\\'")}')" title="Love this track">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="feedback-icon">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 6.00019C10.2006 3.90317 7.19377 3.2551 4.93923 5.17534C2.68468 7.09558 2.36727 10.3061 4.13778 12.5772C5.60984 14.4654 10.0648 18.4479 11.5249 19.7369C11.6882 19.8811 11.7699 19.9532 11.8652 19.9815C11.9483 20.0062 12.0393 20.0062 12.1225 19.9815C12.2178 19.9532 12.2994 19.8811 12.4628 19.7369C13.9229 18.4479 18.3778 14.4654 19.8499 12.5772C21.6204 10.3061 21.3417 7.07538 19.0484 5.17534C16.7551 3.2753 13.7994 3.90317 12 6.00019Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>`;
                    }).join('');
                    // No need to call loadAlbumArt for each song, as it's pre-populated in the backend
                    if (isDiscover) {
                        document.getElementById('lastFmButtons').innerHTML = '<button class="download-btn" id="lastFmDownloadBtn" onclick="downloadLastFmPlaylist()">Download all</button><button onclick="refetchLastFmPlaylist()">Refetch</button>';
                    }
                    statusDiv.textContent = `${data.recommendations.length} songs fetched from Last.fm`;
                    toggleBtn.style.display = 'inline-block';
                    showMessage('info', `Found ${data.recommendations.length} Last.fm recommendations.`);
                } else {
                    playlistDiv.innerHTML = `<div class="playlist-item">${data.message}</div>`;
                    statusDiv.textContent = 'No recommendations found';
                    showMessage(data.status, data.message);
                }
            } catch (error) {
                playlistDiv.innerHTML = `<div class="playlist-item">Network error: ${error.message}</div>`;
                statusDiv.textContent = 'Network error';
                showMessage('error', `Network error: ${error.message}`);
            }
        }

        async function downloadLastFmPlaylistDirect() {
            const response = await fetch('/api/trigger_lastfm_download', {
                method: 'POST'
            });
            const data = await response.json();
            showMessage(data.status, data.message);
        }

        async function downloadLastFmPlaylist() {
            const downloadBtn = document.getElementById('lastFmDownloadBtn');
            downloadBtn.innerHTML = '<div class="spinner" style="margin-right: 8px;"></div>Downloading...';
            downloadBtn.disabled = true;

            // Show immediate feedback message
            showMessage('info', 'Download started...');
            // Add to client-side queue display immediately
            const downloadId = `lastfm-${Date.now()}`;
            downloadQueue.push({ id: downloadId, artist: 'Last.fm Playlist', title: 'Multiple Tracks', status: 'in_progress' });
            updateDownloadQueueUI();

            const response = await fetch('/api/trigger_lastfm_download', {
                method: 'POST'
            });
            const data = await response.json();
            // The polling function will update the actual status
            setTimeout(() => {
                downloadBtn.innerHTML = 'Download';
                downloadBtn.disabled = false;
                showMessage(data.status, data.message);
            }, 2000);
        }

        async function submitListenBrainzFeedback(buttonElement, recording_mbid, score) {
            // Frontend validation for MBID
            if (!recording_mbid || recording_mbid === 'null') {
                showMessage('error', 'Cannot submit feedback: MusicBrainz ID is missing for this track.');
                applyTemporaryFeedbackStyle(buttonElement, 'error');
                return;
            }

            try {
                const response = await fetch('/api/submit_listenbrainz_feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recording_mbid: recording_mbid, score: score })
                });
                const data = await response.json();
                showMessage(data.status, data.message);
                applyTemporaryFeedbackStyle(buttonElement, data.status);
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showMessage('error', 'Failed to submit feedback');
                applyTemporaryFeedbackStyle(buttonElement, 'error'); // Apply error style on network error
            }
        }

        async function submitLastFmFeedback(buttonElement, track, artist) {
            try {
                const response = await fetch('/api/submit_lastfm_feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ track: track, artist: artist })
                });
                const data = await response.json();
                showMessage(data.status, data.message);
                applyTemporaryFeedbackStyle(buttonElement, data.status);
            } catch (error) {
                console.error('Error submitting Last.fm feedback:', error);
                showMessage('error', 'Failed to submit feedback');
                applyTemporaryFeedbackStyle(buttonElement, 'error');
            }
        }

        async function downloadFreshRelease(artist, album, releaseDate) {
            // Get the state of the album recommendation setting from config
            const isAlbumRecommendation = window.albumRecommendationEnabled || false;

            // Show immediate feedback message
            showMessage('info', 'Download started...');
            // Add to client-side queue display immediately
            downloadQueue.push({ artist: artist, title: album, status: 'in_progress' });
            updateDownloadQueueUI();

            const response = await fetch('/api/trigger_fresh_release_download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    artist: artist,
                    album: album,
                    release_date: releaseDate,
                    is_album_recommendation: isAlbumRecommendation
                })
            });
            const data = await response.json();
            showMessage(data.status, data.message);
            // The polling function will update the actual status
        }

        let currentAudio = null; // Global variable to keep track of currently playing audio

        async function playTrackPreview(artist, title, buttonElement) {
            try {
                // If clicking the same button that's already playing, stop the audio
                if (buttonElement.classList.contains('playing') && currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    currentAudio = null;
                    buttonElement.classList.remove('playing');
                    const icon = buttonElement.querySelector('.feedback-icon path');
                    if (icon) {
                        icon.setAttribute('d', 'M5 3L19 12L5 21V3Z'); // Play icon
                    }
                    return;
                }

                // Stop any currently playing audio
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    // Reset previous play button icon
                    const prevPlayBtn = document.querySelector('.play-btn.playing');
                    if (prevPlayBtn) {
                        prevPlayBtn.classList.remove('playing');
                        const prevIcon = prevPlayBtn.querySelector('.feedback-icon path');
                        if (prevIcon) {
                            prevIcon.setAttribute('d', 'M5 3L19 12L5 21V3Z'); // Play icon
                        }
                    }
                }

                // Fetch preview URL
                const response = await fetch(`/api/get_track_preview?artist=${encodeURIComponent(artist)}&title=${encodeURIComponent(title)}`);
                const data = await response.json();

                if (data.status === 'success' && data.preview_url) {
                    // Create new audio element
                    currentAudio = new Audio(data.preview_url);
                    
                    // Update button to show pause icon
                    buttonElement.classList.add('playing');
                    const icon = buttonElement.querySelector('.feedback-icon path');
                    if (icon) {
                        icon.setAttribute('d', 'M6 4H18V20H6V4Z'); // Pause icon
                    }

                    // Handle audio end
                    currentAudio.addEventListener('ended', () => {
                        buttonElement.classList.remove('playing');
                        const icon = buttonElement.querySelector('.feedback-icon path');
                        if (icon) {
                            icon.setAttribute('d', 'M5 3L19 12L5 21V3Z'); // Play icon
                        }
                        currentAudio = null;
                    });

                    // Handle errors
                    currentAudio.addEventListener('error', () => {
                        showMessage('error', 'Failed to play preview');
                        buttonElement.classList.remove('playing');
                        const icon = buttonElement.querySelector('.feedback-icon path');
                        if (icon) {
                            icon.setAttribute('d', 'M5 3L19 12L5 21V3Z'); // Play icon
                        }
                        currentAudio = null;
                    });

                    // Play the audio
                    await currentAudio.play();
                } else {
                    showMessage('error', data.message || 'Preview not available for this track');
                }
            } catch (error) {
                console.error('Error playing preview:', error);
                showMessage('error', 'Failed to play preview');
            }
        }

        async function downloadIndividualTrack(artist, title, buttonElement, lb_recommendation = false, source = 'Manual') {
            try {
                // Update button to show loading state
                const originalContent = buttonElement.innerHTML;
                buttonElement.innerHTML = '<div class="spinner"></div>';
                buttonElement.disabled = true;

                // Show immediate feedback message
                showMessage('info', 'Download started...');
                // Add to client-side queue display immediately
                downloadQueue.push({ artist: artist, title: title, status: 'in_progress' });
                updateDownloadQueueUI();

                const response = await fetch('/api/trigger_track_download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ artist: artist, title: title, lb_recommendation: lb_recommendation, source: source })
                });
                const data = await response.json();
                showMessage(data.status, data.message);

                // Reset button after a delay
                setTimeout(() => {
                    buttonElement.innerHTML = originalContent;
                    buttonElement.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Error downloading track:', error);
                showMessage('error', 'Failed to download track');
                // Reset button on error
                buttonElement.innerHTML = originalContent;
                buttonElement.disabled = false;
            }
        }

        async function fetchFreshReleases() {
            const playlistDiv = document.getElementById('freshReleasesPlaylist');
            playlistDiv.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100px;"><div class="spinner" style="margin-right: 8px;"></div><span>Loading...</span></div>';
            try {
                const response = await fetch('/api/get_fresh_releases');
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (jsonError) {
                    playlistDiv.innerHTML = `<div class="playlist-item">Error: ${response.status} ${response.statusText}<br><pre>${text}</pre></div>`;
                    showMessage('error', `API returned non-JSON response for fresh releases: ${response.status}`);
                    return;
                }

                if (data.status === 'success' && data.releases.length > 0) {
                    playlistDiv.innerHTML = `
                        <div class="carousel-container">
                            <button class="carousel-btn prev-btn" onclick="scrollCarousel('freshReleases', -1)"><</button>
                            <div class="carousel" id="freshReleasesCarousel">
                                ${data.releases.map((release, index) => {
                                    const caaReleaseMbid = release.caa_release_mbid || release.release_mbid || '';
                                    const caaId = release.caa_id || '';
                                    return `<div class="release-item">
                                        <div class="release-art-container">
                                            <img src="/assets/default-album.svg" alt="Album Art" class="release-art"
                                                 id="fr-album-art-${index}"
                                                 data-caa-release-mbid="${caaReleaseMbid}"
                                                 data-caa-id="${caaId}"
                                                 data-artist="${release.artist_credit_name.replace(/"/g, '&quot;')}"
                                                 data-album="${release.release_name.replace(/"/g, '&quot;')}">
                                            <div class="release-art-spinner"></div>
                                        </div>
                                        <div class="release-info">
                                            <div class="release-artist">${release.artist_credit_name}</div>
                                            <div class="release-album">${release.release_name}</div>
                                            <div class="release-date">${release.release_date}</div>
                                            ${release.is_available_on_deezer ? 
                                                `<button class="release-download-btn" onclick="downloadFreshRelease('${release.artist_credit_name.replace(/'/g, "\\'")}', '${release.release_name.replace(/'/g, "\\'")}', '${release.release_date || ''}')">Download</button>` : 
                                                `<button class="release-download-btn" disabled title="Not available on Deezer">Not Available</button>`
                                            }
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                            <button class="carousel-btn next-btn" onclick="scrollCarousel('freshReleases', 1)">></button>
                        </div>
                    `;
                    // Call lazy load function for all album arts after rendering
                    lazyLoadAlbumArts('freshReleasesPlaylist');
                } else {
                    playlistDiv.innerHTML = `<div class="playlist-item">${data.message}</div>`;
                    showMessage(data.status, data.message);
                }
            } catch (error) {
                playlistDiv.innerHTML = `<div class="playlist-item">Network error: ${error.message}</div>`;
                showMessage('error', `Network error fetching fresh releases: ${error.message}`);
            }
        }

        function scrollCarousel(service, direction) {
            const carousel = document.getElementById(`${service}Carousel`);
            const scrollAmount = 220;
            const currentScroll = carousel.scrollLeft;
            const newScroll = currentScroll + (direction * scrollAmount);
            carousel.scrollTo({
                left: newScroll,
                behavior: 'smooth'
            });
        }

        // Lazy loading function
        function lazyLoadAlbumArts(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const images = container.querySelectorAll('.album-art, .release-art');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const caaReleaseMbid = img.dataset.caaReleaseMbid;
                        const caaId = img.dataset.caaId;

                        let imageUrl = '/assets/default-album.svg';

                        if (caaReleaseMbid && caaId) {
                            imageUrl = `http://coverartarchive.org/release/${caaReleaseMbid}/${caaId}-250.jpg`;
                        } else if (caaReleaseMbid) {
                            imageUrl = `https://coverartarchive.org/release/${caaReleaseMbid}/front-250.jpg`; // Simple fallback
                        }

                        const spinner = img.nextElementSibling;
                        if (spinner) spinner.style.display = 'block';
                        img.style.opacity = '0'; // Hide image initially

                        img.src = imageUrl;
                        img.onload = () => {
                            img.classList.add('loaded');
                            img.style.opacity = '1';
                            if (spinner) spinner.style.display = 'none';
                        };
                        img.onerror = async () => {
                            const artist = img.dataset.artist;
                            const album = img.dataset.album;

                            if (artist && album) {
                                try {
                                    const deezerResponse = await fetch(`/api/get_deezer_album_art?artist=${encodeURIComponent(artist)}&album_title=${encodeURIComponent(album)}`);
                                    const deezerData = await deezerResponse.json();
                                    if (deezerData.status === 'success' && deezerData.album_art_url) {
                                        img.src = deezerData.album_art_url;
                                        img.onload = () => {
                                            img.classList.add('loaded');
                                            img.style.opacity = '1';
                                            if (spinner) spinner.style.display = 'none';
                                        };
                                        img.onerror = () => { // Fallback if Deezer image also fails
                                            img.src = '/assets/default-album.svg';
                                            img.classList.add('loaded');
                                            img.style.opacity = '1';
                                            if (spinner) spinner.style.display = 'none';
                                        };
                                    } else {
                                        img.src = '/assets/default-album.svg';
                                        img.classList.add('loaded');
                                        img.style.opacity = '1';
                                        if (spinner) spinner.style.display = 'none';
                                    }
                                } catch (deezerError) {
                                    console.error('Error fetching Deezer album art:', deezerError);
                                    img.src = '/assets/default-album.svg';
                                    img.classList.add('loaded');
                                    img.style.opacity = '1';
                                    if (spinner) spinner.style.display = 'none';
                                }
                            } else {
                                img.src = '/assets/default-album.svg';
                                img.classList.add('loaded');
                                img.style.opacity = '1';
                                if (spinner) spinner.style.display = 'none';
                            }
                        };
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '0px',
                threshold: 0.1
            });

            images.forEach(img => imageObserver.observe(img));
        }

        async function loadConfiguration() {
            // Use cached config if available for instant loading
            let config = window.cachedConfig;

            if (config) {
                // Populate form fields immediately from cache
                populateConfigFields(config);
            }

            // Fetch latest config in background
            try {
                const response = await fetch('/api/config');
                const freshConfig = await response.json();

                // Update cache
                window.cachedConfig = freshConfig;

                // If config changed or no cache was used, update fields
                if (!config || JSON.stringify(config) !== JSON.stringify(freshConfig)) {
                    populateConfigFields(freshConfig);
                }
            } catch (error) {
                console.error('Error loading configuration:', error);
                if (!config) {
                    showMessage('error', 'Failed to load configuration');
                }
            }
        }

        function populateConfigFields(config) {
            // Populate automation fields only (services are now per-user)
            document.getElementById('albumRecommendationEnabled').checked = config.ALBUM_RECOMMENDATION_ENABLED || false;

            // Set global variable for album recommendation setting
            window.albumRecommendationEnabled = config.ALBUM_RECOMMENDATION_ENABLED || false;

            // Update UI visibility based on configuration
            updateUIVisibility(config);
        }

        function updateUIVisibility(config) {
            // Check if configuration is empty (no services configured)
            const hasNavidrome = (config.ROOT_ND && config.ROOT_ND !== '') || (config.USER_ND && config.USER_ND !== '') || (config.PASSWORD_ND && config.PASSWORD_ND !== '');
            const hasListenBrainz = config.LISTENBRAINZ_ENABLED && ((config.TOKEN_LB && config.TOKEN_LB !== '') || (config.USER_LB && config.USER_LB !== ''));
            const hasLastFm = config.LASTFM_ENABLED && ((config.LASTFM_API_KEY && config.LASTFM_API_KEY !== '') || (config.LASTFM_API_SECRET && config.LASTFM_API_SECRET !== '') || (config.LASTFM_USERNAME && config.LASTFM_USERNAME !== ''));
            const hasAnyConfig = hasNavidrome || hasListenBrainz || hasLastFm || (config.DEEZER_ARL && config.DEEZER_ARL !== '');
            const llmSection = document.getElementById('llmSection');

            // Show welcome message if no configuration is set
            const welcomeMessage = document.getElementById('welcomeMessage');
            if (!hasAnyConfig) {
                welcomeMessage.style.display = 'block';
            } else {
                welcomeMessage.style.display = 'none';
            }

            // Show/hide sections based on enabled services and hide options
            const freshReleasesSection = document.getElementById('freshReleasesSection');
            const listenBrainzSection = document.getElementById('listenBrainzSection');
            const lastFmSection = document.getElementById('lastFmSection');
            const llmHeaderContent = document.getElementById('llmHeaderContent');

            // ListenBrainz section is shown if enabled, independent of fresh releases
            if (config.LISTENBRAINZ_ENABLED) {
                listenBrainzSection.style.display = 'block';
            } else {
                listenBrainzSection.style.display = 'none';
            }

            // Fresh releases are part of ListenBrainz, but can be hidden independently
            if (config.LISTENBRAINZ_ENABLED && !config.HIDE_FRESH_RELEASES) {
                freshReleasesSection.style.display = 'block';
            } else {
                freshReleasesSection.style.display = 'none';
            }

            if (config.LASTFM_ENABLED) {
                lastFmSection.style.display = 'block';
            } else {
                lastFmSection.style.display = 'none';
            }

            if (config.LLM_ENABLED) {
                llmSection.style.display = 'block';
                if (config.LLM_PROVIDER === 'gemini') {
                    llmHeaderContent.innerHTML = '<img src="/assets/gemini_logo.svg" alt="Gemini" class="logo service-logo"><h2></h2>';
                } else if (config.LLM_PROVIDER === 'openrouter') {
                    llmHeaderContent.innerHTML = '<img src="/assets/openrouter_logo.svg" alt="OpenRouter" class="logo service-logo"><h2></h2>';
                } else {
                    llmHeaderContent.innerHTML = '<h2>LLM Suggestions</h2>';
                }
            } else {
                llmSection.style.display = 'none';
            }

            // Show/hide downloadFromLinkSection based on configuration and hide option
            const downloadFromLinkSection = document.getElementById('downloadFromLinkSection');
            if (hasAnyConfig && !config.HIDE_DOWNLOAD_FROM_LINK) {
                downloadFromLinkSection.style.display = 'block';
            } else {
                downloadFromLinkSection.style.display = 'none';
            }

            // Show "Run Now" button if any recommendation source is enabled
            const runNowSection = document.getElementById('runNowSection');
            if (hasListenBrainz || hasLastFm || config.LLM_ENABLED) {
                runNowSection.style.display = 'block';
            } else {
                runNowSection.style.display = 'none';
            }
        }

        async function saveAutomationOptions() {
            const hour = document.getElementById('cronHour').value;
            const minute = document.getElementById('cronMinute').value;
            const day = document.getElementById('cronDay').value;
            const disabled = document.getElementById('disableCron').checked;
            const timezone = document.getElementById('cronTimezone').value;

            // Build cron schedule: "MINUTE HOUR * * DAY"
            const schedule = `${minute} ${hour} * * ${day}`;

            try {
                // Update cron schedule
                const cronResponse = await fetch('/api/update_cron', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedule: schedule, timezone: timezone })
                });
                const cronData = await cronResponse.json();

                // Update cron disable state
                const disableResponse = await fetch('/api/toggle_cron', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ disabled: disabled })
                });
                const disableData = await disableResponse.json();

                // Show success message if all operations succeeded
                if (cronData.status === 'success' && disableData.status === 'success') {
                    showMessage('success', 'Automation options saved successfully.');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    const errors = [];
                    if (cronData.status !== 'success') errors.push(`Cron: ${cronData.message}`);
                    if (disableData.status !== 'success') errors.push(`Disable: ${disableData.message}`);
                    showMessage('error', `Failed to save some automation options: ${errors.join(', ')}`);
                }
            } catch (error) {
                console.error('Error saving automation options:', error);
                showMessage('error', 'Failed to save automation options');
            }
        }

        async function runNow() {
            const btn = document.getElementById('runNowBtn');
            btn.disabled = true;
            btn.textContent = 'Fetching recommendations...';
            try {
                const response = await fetch('/api/run_now', { method: 'POST' });
                const data = await response.json();
                showMessage(data.status, data.message);
                openDownloadQueueModal();
            } catch (error) {
                console.error('Error running now:', error);
                showMessage('error', 'Failed to start recommendation fetch');
            }
            btn.disabled = false;
            btn.textContent = 'Fetch All Recommendations Now';
        }

        // Detect playlist URLs client-side for immediate UI feedback
        function _isPlaylistUrl(url) {
            return /deezer\.com(?:\/[a-z]{2})?\/playlist\/\d+/.test(url) ||
                   /link\.deezer\.com\/s\/[a-zA-Z0-9]+/.test(url) ||
                   /open\.spotify\.com\/playlist\/[a-zA-Z0-9]+/.test(url) ||
                   /(?:listen\.)?tidal\.com\/(?:browse\/)?playlist\/[0-9a-zA-Z-]+/.test(url) ||
                   /(?:music\.)?youtube\.com\/playlist\?list=[a-zA-Z0-9_-]+/.test(url);
        }

        // --- Playlist mode popup state ---
        let _pendingPlaylistLink = '';

        async function _showPlaylistPopup(url) {
            _pendingPlaylistLink = url;
            document.getElementById('playlistModeUrl').textContent = url;

            // Reset duplicate section
            const dupSection = document.getElementById('playlistDuplicateSection');
            dupSection.style.display = 'none';
            document.getElementById('playlistRenameInput').style.display = 'none';
            document.getElementById('playlistRenameInput').value = '';
            document.querySelectorAll('input[name="playlistDuplicateAction"]').forEach(r => { if (r.value === 'overwrite') r.checked = true; });

            // Call preflight to check for duplicates
            try {
                const resp = await fetch('/api/playlist_preflight', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const result = await resp.json();
                if (result.status === 'success') {
                    document.getElementById('playlistModeUrl').textContent = `${result.name} (${result.track_count} tracks) — ${url}`;
                    if (result.exists) {
                        dupSection.style.display = 'block';
                        document.getElementById('playlistRenameInput').value = result.name + ' (2)';
                    }
                    // Store the original name for later use
                    dupSection.dataset.originalName = result.name;
                }
            } catch (e) {
                console.error('Preflight error:', e);
            }

            document.getElementById('playlistIntervalSection').classList.add('open');
            document.getElementById('playlistModeOverlay').classList.add('open');
        }

        function _hidePlaylistPopup() {
            document.getElementById('playlistModeOverlay').classList.remove('open');
            _pendingPlaylistLink = '';
            // Reset the download button in case popup was dismissed without submitting
            const downloadLinkBtn = document.getElementById('downloadLinkBtn');
            downloadLinkBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';
            downloadLinkBtn.disabled = false;
        }

        // Close popup on overlay click
        document.getElementById('playlistModeOverlay').addEventListener('click', function(e) {
            if (e.target === this) _hidePlaylistPopup();
        });

        // Toggle rename input visibility based on radio selection
        document.querySelectorAll('input[name="playlistDuplicateAction"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('playlistRenameInput').style.display =
                    this.value === 'rename' ? 'block' : 'none';
            });
        });

        async function submitPlaylistDownload(monitor) {
            const musicLink = _pendingPlaylistLink;
            if (!musicLink) return;

            const pollInterval = parseInt(document.getElementById('playlistPollInterval').value) || 24;

            showMessage('info', monitor
                ? 'Playlist download started. It will be monitored for new tracks.'
                : 'Playlist download started. Check the download queue for progress.');
            openDownloadQueueModal();

            // Determine playlist name override
            let playlistName = null;
            const dupSection = document.getElementById('playlistDuplicateSection');
            if (dupSection.style.display !== 'none') {
                const action = document.querySelector('input[name="playlistDuplicateAction"]:checked').value;
                if (action === 'rename') {
                    playlistName = document.getElementById('playlistRenameInput').value.trim();
                    if (!playlistName) {
                        showMessage('error', 'Please enter a name for the playlist.');
                        return;
                    }
                }
                // overwrite: playlistName stays null, backend uses original name and overwrites
            }

            _hidePlaylistPopup();

            try {
                const body = { link: musicLink, monitor, poll_interval_hours: pollInterval };
                if (playlistName) body.playlist_name = playlistName;
                const response = await fetch('/api/download_from_link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                if (data.status === 'success') {
                    document.getElementById('musicLinkInput').value = '';
                    if (monitor) loadMonitoredPlaylists();
                }
            } catch (error) {
                console.error('Error downloading playlist:', error);
                showMessage('error', 'Failed to initiate playlist download.');
            }

            const downloadLinkBtn = document.getElementById('downloadLinkBtn');
            setTimeout(() => {
                downloadLinkBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';
                downloadLinkBtn.disabled = false;
            }, 500);
        }

        async function downloadFromLink() {
            const musicLink = document.getElementById('musicLinkInput').value.trim();
            const downloadLinkBtn = document.getElementById('downloadLinkBtn');

            if (!musicLink) {
                showMessage('error', 'Please paste a music link to download.');
                return;
            }

            const isPlaylist = _isPlaylistUrl(musicLink);

            if (isPlaylist) {
                // Show popup to choose one-time vs monitor
                _pendingPlaylistLink = musicLink;
                downloadLinkBtn.innerHTML = '<div class="spinner"></div>Processing...';
                downloadLinkBtn.disabled = true;
                _showPlaylistPopup(musicLink);
                return;
            }

            // Non-playlist: download immediately
            const originalContent = downloadLinkBtn.innerHTML;
            downloadLinkBtn.innerHTML = '<div class="spinner"></div>Downloading...';
            downloadLinkBtn.disabled = true;

            showMessage('info', 'Download started...');
            downloadQueue.push({ artist: 'Link Download', title: musicLink, status: 'in_progress' });
            updateDownloadQueueUI();

            try {
                const response = await fetch('/api/download_from_link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ link: musicLink })
                });
                const data = await response.json();
                showMessage(data.status, data.message);
                if (data.status === 'success') {
                    document.getElementById('musicLinkInput').value = '';
                }
            } catch (error) {
                console.error('Error downloading from link:', error);
                showMessage('error', 'Failed to initiate download from link.');
            } finally {
                setTimeout(() => {
                    downloadLinkBtn.innerHTML = originalContent;
                    downloadLinkBtn.disabled = false;
                }, 2000);
            }
        }

        // --- Monitored Playlists Management ---
        async function loadMonitoredPlaylists() {
            const container = document.getElementById('monitoredPlaylistsList');
            if (!container) return;
            try {
                const resp = await fetch('/api/monitored_playlists');
                const data = await resp.json();
                if (data.status !== 'success' || !data.playlists.length) {
                    container.innerHTML = '<p style="color: #666; font-size: 0.9em;">No monitored playlists.</p>';
                    return;
                }
                container.innerHTML = data.playlists.map(p => {
                    const lastSync = p.last_synced ? new Date(p.last_synced).toLocaleString() : 'Never';
                    const platform = (p.platform || '').charAt(0).toUpperCase() + (p.platform || '').slice(1);
                    return `
                        <div class="mp-item" data-id="${p.id}">
                            <div class="mp-item-info">
                                <div class="mp-item-name" title="${_escHtml(p.url)}">${_escHtml(p.name)}</div>
                                <div class="mp-item-meta">${platform} &middot; ${p.last_track_count || '?'} tracks &middot; Last sync: ${lastSync}</div>
                            </div>
                            <div class="mp-item-actions">
                                <select onchange="updateMonitoredInterval('${p.id}', this.value)" title="Poll interval">
                                    ${[6,12,24,48,168].map(h =>
                                        `<option value="${h}" ${p.poll_interval_hours === h ? 'selected' : ''}>${h < 48 ? h + 'h' : h === 48 ? '2d' : '7d'}</option>`
                                    ).join('')}
                                </select>
                                <button class="mp-btn-sync" onclick="syncMonitoredPlaylist('${p.id}')" title="Sync now">Sync</button>
                                <button class="mp-btn-remove" onclick="removeMonitoredPlaylist('${p.id}')" title="Stop monitoring">&#x2715;</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                container.innerHTML = '<p style="color: var(--error-color); font-size: 0.9em;">Failed to load.</p>';
            }
        }

        async function updateMonitoredInterval(id, hours) {
            await fetch(`/api/monitored_playlists/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ poll_interval_hours: parseInt(hours) })
            });
        }

        async function syncMonitoredPlaylist(id) {
            const resp = await fetch(`/api/monitored_playlists/${id}/sync`, { method: 'POST' });
            const data = await resp.json();
            showMessage(data.status, data.message);
            openDownloadQueueModal();
            // Periodically refresh the monitored list to show updated track count / last sync
            const refreshInterval = setInterval(() => loadMonitoredPlaylists(), 10000);
            setTimeout(() => clearInterval(refreshInterval), 120000);
        }

        async function removeMonitoredPlaylist(id) {
            await fetch(`/api/monitored_playlists/${id}`, { method: 'DELETE' });
            loadMonitoredPlaylists();
        }

        // --- User Settings API ---
        async function saveUserSettings() {
            const settings = {
                listenbrainz_enabled: document.getElementById('listenbrainzEnabled').checked,
                listenbrainz_username: document.getElementById('listenbrainzUser').value.trim(),
                listenbrainz_token: document.getElementById('listenbrainzToken').value.trim(),
                lastfm_enabled: document.getElementById('lastfmEnabled').checked,
                lastfm_username: document.getElementById('lastfmUsername').value.trim(),
                lastfm_password: document.getElementById('lastfmPassword').value.trim(),
                lastfm_api_key: document.getElementById('lastfmApiKey').value.trim(),
                lastfm_api_secret: document.getElementById('lastfmApiSecret').value.trim(),
            };
            try {
                const response = await fetch('/api/user/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                const data = await response.json();
                showMessage(data.status, data.message);
                if (data.status === 'success') {
                    setTimeout(() => location.reload(), 1000);
                }
            } catch (error) {
                showMessage('error', 'Failed to save settings');
            }
        }

        async function loadUserSettings() {
            try {
                const response = await fetch('/api/user/settings');
                const data = await response.json();
                if (data.status === 'success') {
                    const s = data.settings;
                    document.getElementById('listenbrainzEnabled').checked = s.listenbrainz_enabled || false;
                    document.getElementById('listenbrainzUser').value = s.listenbrainz_username || '';
                    document.getElementById('listenbrainzToken').value = s.listenbrainz_token || '';
                    document.getElementById('lastfmEnabled').checked = s.lastfm_enabled || false;
                    document.getElementById('lastfmUsername').value = s.lastfm_username || '';
                    document.getElementById('lastfmPassword').value = s.lastfm_password || '';
                    document.getElementById('lastfmApiKey').value = s.lastfm_api_key || '';
                    document.getElementById('lastfmApiSecret').value = s.lastfm_api_secret || '';
                    updateListenBrainzVisibility();
                    updateLastFmVisibility();
                }
            } catch (error) {
                console.error('Error loading user settings:', error);
            }
        }

        // --- Setup Wizard ---
        async function completeSetupWizard() {
            const settings = {};
            if (document.getElementById('wizardLbEnabled').checked) {
                settings.listenbrainz_enabled = true;
                settings.listenbrainz_username = document.getElementById('wizardLbUser').value.trim();
                settings.listenbrainz_token = document.getElementById('wizardLbToken').value.trim();
            }
            if (document.getElementById('wizardLfEnabled').checked) {
                settings.lastfm_enabled = true;
                settings.lastfm_username = document.getElementById('wizardLfUsername').value.trim();
                settings.lastfm_password = document.getElementById('wizardLfPassword').value.trim();
                settings.lastfm_api_key = document.getElementById('wizardLfApiKey').value.trim();
                settings.lastfm_api_secret = document.getElementById('wizardLfApiSecret').value.trim();
            }
            try {
                if (Object.keys(settings).length > 0) {
                    await fetch('/api/user/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                }
                await fetch('/api/user/setup_done', { method: 'POST' });
                document.getElementById('setupWizard').style.display = 'none';
                location.reload();
            } catch (error) {
                showMessage('error', 'Failed to save setup');
            }
        }

        async function skipSetupWizard() {
            try {
                await fetch('/api/user/setup_done', { method: 'POST' });
                document.getElementById('setupWizard').style.display = 'none';
            } catch (error) {
                console.error('Error skipping setup:', error);
            }
        }

        // PWA Service Worker
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');

        // Auto-load content based on configuration
        window.onload = async function() {
            // Show setup wizard if first time
            {% if first_time %}
            document.getElementById('setupWizard').style.display = 'block';
            {% endif %}

            // Load configuration first to determine what to show
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                // Cache the configuration for faster settings modal loading
                window.cachedConfig = config;

                // Update UI visibility
                updateUIVisibility(config);

                // Fresh releases hidden by default
                {% if hide_fresh_releases %}
                document.getElementById('freshReleasesSection').style.display = 'none';
                {% else %}
                if (config.LISTENBRAINZ_ENABLED && !config.HIDE_FRESH_RELEASES) {
                    setTimeout(fetchFreshReleases, 100);
                }
                {% endif %}
            } catch (error) {
                console.error('Error loading initial configuration:', error);
                document.getElementById('welcomeMessage').style.display = 'block';
            }

            // PWA share target: auto-submit shared URL
            {% if pending_share_url %}
            const sharedUrl = {{ pending_share_url | tojson }};
            if (sharedUrl) {
                const linkInput = document.getElementById('musicLinkInput');
                if (linkInput) {
                    linkInput.value = sharedUrl;
                    // Scroll the download section into view
                    linkInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Small delay to let UI settle, then trigger download
                    setTimeout(() => downloadFromLink(), 500);
                }
            }
            {% endif %}
        };
    </script>
</body>
</html>
